# Inevitable

> **基于并行证明数搜索（Parallel PNS）的五子棋强求解器**

**Inevitable** 是一个以“先手必胜”理论为基础的现代五子棋求解引擎。不同于传统的基于评分（Minimax/Alpha-Beta Pruning）的 AI，Inevitable 的目标不是单纯的“下得好”，而是追求**数学上的全局最优解**。

它的核心设计哲学是：在计算资源允许的范围内，寻找一条**严格的数学证明路径**，确保在对手任意应对的情况下，程序都能导向胜利，并且总是选择**通往胜利的最短路径**。

## 核心特性

*   **严格求解**：基于 AND/OR 树的博弈论求解，输出结果为“证明（Proven）”或“证伪（Disproven）”，而非概率评分。
*   **最短路径**：内置步数感知机制，在存在多个必胜分支时，自动收敛至步数最少的杀棋路径。
*   **并行加速**：利用多核 CPU 进行并行搜索，通过虚拟压力（Virtual Pressure）机制解决并行带来的搜索开销爆炸问题。
*   **极致性能**：底层采用位棋盘（Bitboard）与 SIMD 友好的数据结构，配合无锁/细粒度锁设计。

## 算法架构

Inevitable 并非通过“估值”来判断局面优劣，而是通过**证明**来确定局面性质。

### 1. 并行证明数搜索 (Parallel Proof-Number Search)

这是本引擎的核心驱动力。PNS 是一种专门用于在 AND/OR 树中寻找目标状态（如五子棋的连五）的最佳优先搜索算法。

*   **证明数 (PN) 与 证伪数 (DN)**：
    *   每个节点维护两个核心数值：`pn`（证明该节点为真最少需要证明的子节点数）和 `dn`（证伪该节点最少需要证伪的子节点数）。
    *   程序总是优先扩展 `pn` 或 `dn` 最小的节点（即“最容易突破的瓶颈”），从而极大地减少了无效搜索分支。
*   **并行化策略**：
    *   采用 **Virtual Proof/Disproof Number (VPN/VDN)** 机制。当一个线程正在评估某个节点时，会给该节点施加“虚拟压力”，暂时人为提高其 PN/DN 值。
    *   这防止了其他线程“扎堆”搜索同一个分支，迫使它们去探索次优但有潜力的分支，从而实现真正的并行宽搜。

### 2. 威胁索引 (Threat Index) 与 增量更新

为了在毫秒级内生成高质量的候选着法，Inevitable 摒弃了全盘扫描，采用了一套复杂的**威胁索引系统**。

*   **滑动窗口模型**：引擎预先计算了棋盘上所有可能的“五元组”窗口（横、竖、斜）。
*   **桶排序管理 (Buckets)**：所有窗口根据其状态（如“我方3子+0敌子”）被实时维护在不同的桶中。
*   **增量更新**：每一步落子或撤销，仅更新受影响的局部窗口，时间复杂度接近 $O(1)$。
*   **逼着生成 (Forcing Moves)**：系统能瞬间识别出所有“冲四”、“活三”等必须应手的点，优先于普通着法进行搜索，极大压缩了搜索空间。

### 3. 置换表 (Transposition Table) 与 Zobrist 哈希

五子棋的状态空间是一个有向无环图（DAG），不同的走子顺序可能到达同一局面。

*   **Zobrist Hashing**：利用异或运算快速计算局面的唯一指纹。
*   **规范化哈希 (Canonical Hashing)**：利用五子棋的几何对称性（旋转、镜像），将 8 种对称局面映射为同一个哈希值，将搜索空间压缩了约 8 倍。
*   **全局缓存**：搜索结果被存储在全局置换表中。当遇到重复局面时，直接复用已知的 PN/DN 值和“最短胜利步数”，避免重复计算。

### 4. 位棋盘 (Bitboard) 技术

为了极致的运算速度，棋盘状态并非由二维数组表示，而是由多个 64 位整数（`u64`）组成的位棋盘。

*   **并行逻辑运算**：判断是否连五、查找空位、计算邻域掩码等操作，均通过位运算（AND, OR, SHIFT）一次性处理 64 个棋位。
*   **CPU 缓存友好**：紧凑的数据结构减少了内存占用和缓存未命中率。

### 5. 迭代加深与最短路收敛

为了在有限时间内给出最佳反馈，并在必胜时选择最快杀法：

*   引擎记录了每个已证明节点的 `win_len`（胜利步数）。
*   在 AND 节点（对手回合），取所有子节点中最慢的胜利路径（对手会顽强抵抗）。
*   在 OR 节点（我方回合），取所有必胜子节点中最快的胜利路径。
*   搜索深度通过迭代加深（Iterative Deepening）逐步放开，确保在复杂局面下的时间管理。

## 构建与运行

本项目使用 Rust 编写，确保内存安全与高性能。

### 环境要求
*   Rust (Edition 2024, Nightly/Stable compatible)
*   支持多线程的 CPU

### 编译
```bash
# Release 模式编译以获得最佳性能
cargo build --release
```

### 运行
```bash
# 启动程序
./target/release/five_stone
```

### 配置文件 (config.yaml)
你可以通过 `config.yaml` 调整搜索参数：
```yaml
board_size: 15     # 棋盘大小 (标准为15)
win_len: 5         # 连珠数量
verbose: true      # 输出详细搜索日志
num_threads: 12    # 并行搜索线程数
```

## 📊 性能可视化

项目包含 `visualization.py`，可解析生成的 `log.csv`，生成搜索过程中的内存分配、耗时分布、Transposition Table 命中率等图表，帮助开发者进一步调优算法瓶颈。

## 许可证

本项目遵循 [Apache License 2.0](https://www.apache.org/licenses/LICENSE-2.0) 协议。详情请参阅 [LICENSE](LICENSE) 文件。
